name: Sync Docs to Documentation Site

on:
  push:
    branches:
      - main
    paths:
      - 'user-guide/**'

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout srs-writer-plugin
        uses: actions/checkout@v4

      - name: Checkout testany_docs_for_user
        uses: actions/checkout@v4
        with:
          repository: TestAny-io/testany_docs_for_user
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: docs-site
          fetch-depth: 0  # Full history needed for changelog generation

      - name: Sync documentation files
        run: |
          # Create target directories if they don't exist
          mkdir -p docs-site/public/docs/srs-writer/en
          mkdir -p docs-site/public/docs/srs-writer/zh
          mkdir -p docs-site/public/docs/srs-writer/images/en
          mkdir -p docs-site/public/docs/srs-writer/images/zh

          # Sync English docs (all .md files, filenames are now clean)
          if [ -d "user-guide/drafts/en" ]; then
            for f in user-guide/drafts/en/*.md; do
              if [ -f "$f" ]; then
                cp "$f" "docs-site/public/docs/srs-writer/en/"
                echo "Copied: $f"
              fi
            done
          fi

          # Sync Chinese docs
          if [ -d "user-guide/drafts/zh" ]; then
            for f in user-guide/drafts/zh/*.md; do
              if [ -f "$f" ]; then
                cp "$f" "docs-site/public/docs/srs-writer/zh/"
                echo "Copied: $f"
              fi
            done
          fi

          # Sync English images
          if [ -d "user-guide/drafts/images/en" ]; then
            cp -r user-guide/drafts/images/en/* docs-site/public/docs/srs-writer/images/en/ 2>/dev/null || true
            echo "Synced English images"
          fi

          # Sync Chinese images
          if [ -d "user-guide/drafts/images/zh" ]; then
            cp -r user-guide/drafts/images/zh/* docs-site/public/docs/srs-writer/images/zh/ 2>/dev/null || true
            echo "Synced Chinese images"
          fi

      - name: Add frontmatter, regenerate configs, and update changelog
        run: |
          cd docs-site
          npm ci
          # Add frontmatter to synced docs (idempotent - skips files with existing frontmatter)
          node scripts/add-srs-writer-frontmatter.cjs
          # Regenerate navigation config from frontmatter
          node scripts/generate-srs-writer-nav-config.cjs
          # Regenerate changelog (requires full git history)
          node scripts/generate-changelog.js

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.DOCS_SYNC_TOKEN }}
        run: |
          cd docs-site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create a unique branch name with timestamp
          BRANCH_NAME="docs/sync-srs-writer-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git commit -m "docs: sync SRS Writer docs from srs-writer-plugin

          Automated sync triggered by changes to user-guide/ in srs-writer-plugin.

          ðŸ¤– Generated with GitHub Actions"

          # Push the branch
          git push -u origin "$BRANCH_NAME"

          # Create PR using GitHub CLI
          gh pr create \
            --repo TestAny-io/testany_docs_for_user \
            --base main \
            --head "$BRANCH_NAME" \
            --title "docs: sync SRS Writer documentation" \
            --body "## Automated Documentation Sync

          This PR was automatically created by the docs sync workflow in \`srs-writer-plugin\`.

          ### Changes
          - Synced documentation from \`user-guide/\` directory
          - Added frontmatter to markdown files
          - Regenerated navigation config
          - Updated changelog

          ### Preview
          Once CI completes, a Cloudflare Pages preview will be available for testing.

          ### Source
          Triggered by: ${{ github.event.head_commit.url }}

          ---
          ðŸ¤– Generated with GitHub Actions"
